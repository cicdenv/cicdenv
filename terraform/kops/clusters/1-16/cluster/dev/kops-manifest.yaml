---
apiVersion: kops/v1alpha2
kind: Cluster
metadata:
  name: 1-16-dev.kops.cicdenv.com
spec:
  addons:
  - manifest: s3://kops.cicdenv.com/1-16-dev.kops.cicdenv.com/addons/custom-channel.yaml
  api:
    loadBalancer:
      type: Internal
      additionalSecurityGroups: [sg-0d6bdebe202ab34f7]
  authentication:
    aws: {}
  authorization:
    rbac: {}
  channel: stable
  cloudProvider: aws
  configBase: s3://kops.cicdenv.com/1-16-dev.kops.cicdenv.com
  dnsZone: Z07667821MG3M6R8WBLV2
  etcdClusters:
  - etcdMembers:
    - instanceGroup: master-us-west-2a
      name: a
      encryptedVolume: true
      kmsKeyId: arn:aws:kms:us-west-2:977594567050:key/48c98ebb-cd61-4b10-a8c4-f50337c39d5a
    - instanceGroup: master-us-west-2b
      name: b
      encryptedVolume: true
      kmsKeyId: arn:aws:kms:us-west-2:977594567050:key/48c98ebb-cd61-4b10-a8c4-f50337c39d5a
    - instanceGroup: master-us-west-2c
      name: c
      encryptedVolume: true
      kmsKeyId: arn:aws:kms:us-west-2:977594567050:key/48c98ebb-cd61-4b10-a8c4-f50337c39d5a
    name: main
  - etcdMembers:
    - instanceGroup: master-us-west-2a
      name: a
      encryptedVolume: true
      kmsKeyId: arn:aws:kms:us-west-2:977594567050:key/48c98ebb-cd61-4b10-a8c4-f50337c39d5a
    - instanceGroup: master-us-west-2b
      name: b
      encryptedVolume: true
      kmsKeyId: arn:aws:kms:us-west-2:977594567050:key/48c98ebb-cd61-4b10-a8c4-f50337c39d5a
    - instanceGroup: master-us-west-2c
      name: c
      encryptedVolume: true
      kmsKeyId: arn:aws:kms:us-west-2:977594567050:key/48c98ebb-cd61-4b10-a8c4-f50337c39d5a
    name: events
  iam:
    allowContainerRegistry: true
    legacy: false
  kubeDNS:
    provider: CoreDNS
  kubernetesApiAccess:
  - 0.0.0.0/0
  kubelet:
    anonymousAuth: false
  kubernetesVersion: 1.16.3
  masterInternalName: api.internal.1-16-dev.kops.cicdenv.com
  masterPublicName: api.1-16-dev.kops.cicdenv.com
  networkCIDR: 10.16.0.0/16
  networkID: vpc-03ce7f18d661db2f5
  networking:
    canal: {}
  nonMasqueradeCIDR: 100.64.0.0/10
  subnets:
  - cidr: 10.16.32.0/19
    id: subnet-0673a862ec92f4907
    name: us-west-2a
    type: Private
    zone: us-west-2a
  - cidr: 10.16.64.0/19
    id: subnet-028cf9af64c3fd6e4
    name: us-west-2b
    type: Private
    zone: us-west-2b
  - cidr: 10.16.96.0/19
    id: subnet-01bf67506493cc23e
    name: us-west-2c
    type: Private
    zone: us-west-2c
  - cidr: 10.16.0.0/22
    id: subnet-0f55797e4f96ff3d5
    name: utility-us-west-2a
    type: Utility
    zone: us-west-2a
  - cidr: 10.16.4.0/22
    id: subnet-031b9e07bc61bf051
    name: utility-us-west-2b
    type: Utility
    zone: us-west-2b
  - cidr: 10.16.8.0/22
    id: subnet-03561296ece3e2335
    name: utility-us-west-2c
    type: Utility
    zone: us-west-2c
  topology:
    dns:
      type: Private
    masters: private
    nodes: private
  fileAssets:
  - name: kubernetes-audit
    path: /srv/kubernetes/audit.yaml
    roles: [Master]
    content: |
      apiVersion: audit.k8s.io/v1
      kind: Policy
      omitStages:
        - "RequestReceived"
      rules:
      - level: None
        users: ["system:kube-proxy"]
        verbs: ["watch"]
        resources:
          - group: ""
            resources: ["endpoints", "services", "services/status"]
      - level: None
        userGroups: ["system:nodes"]
        verbs: ["get"]
        resources:
          - group: ""
            resources: ["nodes", "nodes/status"]
      - level: None
        users:
          - system:kube-controller-manager
          - system:kube-scheduler
          - system:serviceaccount:kube-system:endpoint-controller
        verbs: ["get", "update"]
        namespaces: ["kube-system"]
        resources:
          - group: ""
            resources: ["endpoints"]
      - level: None
        users: ["system:apiserver"]
        verbs: ["get"]
        resources:
          - group: ""
            resources: ["namespaces", "namespaces/status", "namespaces/finalize"]
      - level: None
        users: ["cluster-autoscaler"]
        verbs: ["get", "update"]
        namespaces: ["kube-system"]
        resources:
          - group: ""
            resources: ["configmaps", "endpoints"]
      - level: None
        users:
          - system:kube-controller-manager
        verbs: ["get", "list"]
        resources:
          - group: "metrics.k8s.io"
      - level: None
        nonResourceURLs:
          - /healthz*
          - /version
          - /swagger*
      - level: None
        resources:
          - group: ""
            resources: ["events"]
      - level: None
        resources:
        - group: ""
          resources: ["configmaps"]
          resourceNames: ["controller-leader"]
      - level: None
        userGroups: ["system:authenticated"]
        nonResourceURLs:
        - "/api*"
        - "/version"
      - level: RequestResponse
        resources:
        - group: ""
          resources: ["pods"]
      - level: Request
        users:
        - "kubelet"
        - "system:node-problem-detector"
        - "system:serviceaccount:kube-system:node-problem-detector"
        verbs: ["update","patch"]
        resources:
          - group: ""
            resources: ["nodes/status", "pods/status"]
        omitStages:
          - "RequestReceived"
      - level: Request
        userGroups: ["system:nodes"]
        verbs: ["update","patch"]
        resources:
          - group: ""
            resources: ["nodes/status", "pods/status"]
        omitStages:
          - "RequestReceived"
      - level: Request
        users: ["system:serviceaccount:kube-system:namespace-controller"]
        verbs: ["deletecollection"]
        omitStages:
          - "RequestReceived"
      - level: Request
        verbs: ["get", "list", "watch"]
        resources:
          - group: ""
          - group: "admissionregistration.k8s.io"
          - group: "apiextensions.k8s.io"
          - group: "apiregistration.k8s.io"
          - group: "apps"
          - group: "authentication.k8s.io"
          - group: "authorization.k8s.io"
          - group: "autoscaling"
          - group: "batch"
          - group: "certificates.k8s.io"
          - group: "extensions"
          - group: "metrics.k8s.io"
          - group: "networking.k8s.io"
          - group: "node.k8s.io"
          - group: "policy"
          - group: "rbac.authorization.k8s.io"
          - group: "scheduling.k8s.io"
          - group: "settings.k8s.io"
          - group: "storage.k8s.io"
        omitStages:
          - "RequestReceived"
      - level: RequestResponse
        resources:
          - group: ""
          - group: "admissionregistration.k8s.io"
          - group: "apiextensions.k8s.io"
          - group: "apiregistration.k8s.io"
          - group: "apps"
          - group: "authentication.k8s.io"
          - group: "authorization.k8s.io"
          - group: "autoscaling"
          - group: "batch"
          - group: "certificates.k8s.io"
          - group: "extensions"
          - group: "metrics.k8s.io"
          - group: "networking.k8s.io"
          - group: "node.k8s.io"
          - group: "policy"
          - group: "rbac.authorization.k8s.io"
          - group: "scheduling.k8s.io"
          - group: "settings.k8s.io"
          - group: "storage.k8s.io"
        omitStages:
          - "RequestReceived"
      - level: Request
        resources:
        - group: ""
        - group: "extensions"
      - level: Metadata
        resources:
        - group: ""
          resources: ["secrets", "configmaps"]
      - level: Metadata
        resources:
          - group: ""
            resources: ["secrets", "configmaps"]
          - group: authentication.k8s.io
            resources: ["tokenreviews"]
        omitStages:
          - "RequestReceived"
      - level: Metadata
        omitStages:
          - "RequestReceived"
  kubeAPIServer:
    auditLogPath:       /var/log/kube-apiserver-audit.log
    auditPolicyFile:    /srv/kubernetes/audit.yaml
    auditLogMaxAge:       10 # Days
    auditLogMaxBackups:    1 # Logs to retain
    auditLogMaxSize:     100 # Max size in MB
---
apiVersion: kops/v1alpha2
kind: InstanceGroup
metadata:
  labels:
    kops.k8s.io/cluster: 1-16-dev.kops.cicdenv.com
  name: master-us-west-2a
spec:
  image: ami-0b685c2061ff41b7d
  machineType: c5.large
  maxSize: 1
  minSize: 1
  nodeLabels:
    kops.k8s.io/instancegroup: master-us-west-2a
  role: Master
  rootVolumeSize: 100
  iam:
    profile: arn:aws:iam::977594567050:instance-profile/kops-master
  additionalSecurityGroups: [sg-0f706a2f429e15e16]
  additionalUserData:
  - name: a-instance-stores
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      mount_dir=/mnt/ephemeral
      
      #
      # Configures NVMe instance stores.
      # This runs before docker/k8s are installed.
      #
      
      # Use script from our custom base AMI
      /usr/local/bin/mount-all-ephemeral-devices.sh "$mount_dir"
      
      #
      # Bind mounts for docker+kubernetes
      #
      for target_dir in        \
          /var/lib/containerd  \
          /var/lib/docker      \
          /var/lib/kubelet     \
          ; do
          real_dir="$mount_dir/$(basename $target_dir)"
      
          if [[ ! -d "$target_dir" ]]; then
              mkdir -p "$real_dir"
              mkdir -p "$target_dir"
      
              mount -o bind "$real_dir" "$target_dir"
          fi
      done
      
  - name: a-setup-dns
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      #
      # Fixed CoreDNS on nodes.
      #   Needed on ubuntu 18.04
      #
      
      # Stop systemd-resolved
      if systemctl is-active --quiet systemd-resolved; then
          systemctl disable systemd-resolved
          systemctl stop systemd-resolved
      fi
      
      # Link /etc/resolv.conf to /run/systemd/resolve/resolv.conf
      if [[ "$(readlink -- /etc/resolv.conf)" == "../run/systemd/resolve/stub-resolv.conf" ]]; then
          rm -f "/etc/resolv.conf"
          ln -s "/run/systemd/resolve/resolv.conf" "/etc/resolv.conf"
      fi
      

  subnets:
  - us-west-2a
  cloudLabels:

  detailedInstanceMonitoring: true
---
apiVersion: kops/v1alpha2
kind: InstanceGroup
metadata:
  labels:
    kops.k8s.io/cluster: 1-16-dev.kops.cicdenv.com
  name: master-us-west-2b
spec:
  image: ami-0b685c2061ff41b7d
  machineType: c5.large
  maxSize: 1
  minSize: 1
  nodeLabels:
    kops.k8s.io/instancegroup: master-us-west-2b
  role: Master
  rootVolumeSize: 100
  iam:
    profile: arn:aws:iam::977594567050:instance-profile/kops-master
  additionalSecurityGroups: [sg-0f706a2f429e15e16]
  additionalUserData:
  - name: a-instance-stores
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      mount_dir=/mnt/ephemeral
      
      #
      # Configures NVMe instance stores.
      # This runs before docker/k8s are installed.
      #
      
      # Use script from our custom base AMI
      /usr/local/bin/mount-all-ephemeral-devices.sh "$mount_dir"
      
      #
      # Bind mounts for docker+kubernetes
      #
      for target_dir in        \
          /var/lib/containerd  \
          /var/lib/docker      \
          /var/lib/kubelet     \
          ; do
          real_dir="$mount_dir/$(basename $target_dir)"
      
          if [[ ! -d "$target_dir" ]]; then
              mkdir -p "$real_dir"
              mkdir -p "$target_dir"
      
              mount -o bind "$real_dir" "$target_dir"
          fi
      done
      
  - name: a-setup-dns
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      #
      # Fixed CoreDNS on nodes.
      #   Needed on ubuntu 18.04
      #
      
      # Stop systemd-resolved
      if systemctl is-active --quiet systemd-resolved; then
          systemctl disable systemd-resolved
          systemctl stop systemd-resolved
      fi
      
      # Link /etc/resolv.conf to /run/systemd/resolve/resolv.conf
      if [[ "$(readlink -- /etc/resolv.conf)" == "../run/systemd/resolve/stub-resolv.conf" ]]; then
          rm -f "/etc/resolv.conf"
          ln -s "/run/systemd/resolve/resolv.conf" "/etc/resolv.conf"
      fi
      

  subnets:
  - us-west-2b
  cloudLabels:

  detailedInstanceMonitoring: true
---
apiVersion: kops/v1alpha2
kind: InstanceGroup
metadata:
  labels:
    kops.k8s.io/cluster: 1-16-dev.kops.cicdenv.com
  name: master-us-west-2c
spec:
  image: ami-0b685c2061ff41b7d
  machineType: c5.large
  maxSize: 1
  minSize: 1
  nodeLabels:
    kops.k8s.io/instancegroup: master-us-west-2c
  role: Master
  rootVolumeSize: 100
  iam:
    profile: arn:aws:iam::977594567050:instance-profile/kops-master
  additionalSecurityGroups: [sg-0f706a2f429e15e16]
  additionalUserData:
  - name: a-instance-stores
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      mount_dir=/mnt/ephemeral
      
      #
      # Configures NVMe instance stores.
      # This runs before docker/k8s are installed.
      #
      
      # Use script from our custom base AMI
      /usr/local/bin/mount-all-ephemeral-devices.sh "$mount_dir"
      
      #
      # Bind mounts for docker+kubernetes
      #
      for target_dir in        \
          /var/lib/containerd  \
          /var/lib/docker      \
          /var/lib/kubelet     \
          ; do
          real_dir="$mount_dir/$(basename $target_dir)"
      
          if [[ ! -d "$target_dir" ]]; then
              mkdir -p "$real_dir"
              mkdir -p "$target_dir"
      
              mount -o bind "$real_dir" "$target_dir"
          fi
      done
      
  - name: a-setup-dns
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      #
      # Fixed CoreDNS on nodes.
      #   Needed on ubuntu 18.04
      #
      
      # Stop systemd-resolved
      if systemctl is-active --quiet systemd-resolved; then
          systemctl disable systemd-resolved
          systemctl stop systemd-resolved
      fi
      
      # Link /etc/resolv.conf to /run/systemd/resolve/resolv.conf
      if [[ "$(readlink -- /etc/resolv.conf)" == "../run/systemd/resolve/stub-resolv.conf" ]]; then
          rm -f "/etc/resolv.conf"
          ln -s "/run/systemd/resolve/resolv.conf" "/etc/resolv.conf"
      fi
      

  subnets:
  - us-west-2c
  cloudLabels:

  detailedInstanceMonitoring: true
---
apiVersion: kops/v1alpha2
kind: InstanceGroup
metadata:
  labels:
    kops.k8s.io/cluster: 1-16-dev.kops.cicdenv.com
  name: nodes-us-west-2a
spec:
  image: ami-0b685c2061ff41b7d
  machineType: r5d.xlarge
  maxSize: 1
  minSize: 1
  nodeLabels:
    kops.k8s.io/instancegroup: nodes-us-west-2a
  role: Node
  rootVolumeSize: 100
  iam:
    profile: arn:aws:iam::977594567050:instance-profile/kops-node
  additionalSecurityGroups: [sg-0f52c9ae7bc8bfb73]
  additionalUserData:
  - name: a-instance-stores
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      mount_dir=/mnt/ephemeral
      
      #
      # Configures NVMe instance stores.
      # This runs before docker/k8s are installed.
      #
      
      # Use script from our custom base AMI
      /usr/local/bin/mount-all-ephemeral-devices.sh "$mount_dir"
      
      #
      # Bind mounts for docker+kubernetes
      #
      for target_dir in        \
          /var/lib/containerd  \
          /var/lib/docker      \
          /var/lib/kubelet     \
          ; do
          real_dir="$mount_dir/$(basename $target_dir)"
      
          if [[ ! -d "$target_dir" ]]; then
              mkdir -p "$real_dir"
              mkdir -p "$target_dir"
      
              mount -o bind "$real_dir" "$target_dir"
          fi
      done
      
  - name: a-setup-dns
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      #
      # Fixed CoreDNS on nodes.
      #   Needed on ubuntu 18.04
      #
      
      # Stop systemd-resolved
      if systemctl is-active --quiet systemd-resolved; then
          systemctl disable systemd-resolved
          systemctl stop systemd-resolved
      fi
      
      # Link /etc/resolv.conf to /run/systemd/resolve/resolv.conf
      if [[ "$(readlink -- /etc/resolv.conf)" == "../run/systemd/resolve/stub-resolv.conf" ]]; then
          rm -f "/etc/resolv.conf"
          ln -s "/run/systemd/resolve/resolv.conf" "/etc/resolv.conf"
      fi
      

  subnets:
  - us-west-2a
  cloudLabels:

  detailedInstanceMonitoring: true
---
apiVersion: kops/v1alpha2
kind: InstanceGroup
metadata:
  labels:
    kops.k8s.io/cluster: 1-16-dev.kops.cicdenv.com
  name: nodes-us-west-2b
spec:
  image: ami-0b685c2061ff41b7d
  machineType: r5d.xlarge
  maxSize: 1
  minSize: 1
  nodeLabels:
    kops.k8s.io/instancegroup: nodes-us-west-2b
  role: Node
  rootVolumeSize: 100
  iam:
    profile: arn:aws:iam::977594567050:instance-profile/kops-node
  additionalSecurityGroups: [sg-0f52c9ae7bc8bfb73]
  additionalUserData:
  - name: a-instance-stores
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      mount_dir=/mnt/ephemeral
      
      #
      # Configures NVMe instance stores.
      # This runs before docker/k8s are installed.
      #
      
      # Use script from our custom base AMI
      /usr/local/bin/mount-all-ephemeral-devices.sh "$mount_dir"
      
      #
      # Bind mounts for docker+kubernetes
      #
      for target_dir in        \
          /var/lib/containerd  \
          /var/lib/docker      \
          /var/lib/kubelet     \
          ; do
          real_dir="$mount_dir/$(basename $target_dir)"
      
          if [[ ! -d "$target_dir" ]]; then
              mkdir -p "$real_dir"
              mkdir -p "$target_dir"
      
              mount -o bind "$real_dir" "$target_dir"
          fi
      done
      
  - name: a-setup-dns
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      #
      # Fixed CoreDNS on nodes.
      #   Needed on ubuntu 18.04
      #
      
      # Stop systemd-resolved
      if systemctl is-active --quiet systemd-resolved; then
          systemctl disable systemd-resolved
          systemctl stop systemd-resolved
      fi
      
      # Link /etc/resolv.conf to /run/systemd/resolve/resolv.conf
      if [[ "$(readlink -- /etc/resolv.conf)" == "../run/systemd/resolve/stub-resolv.conf" ]]; then
          rm -f "/etc/resolv.conf"
          ln -s "/run/systemd/resolve/resolv.conf" "/etc/resolv.conf"
      fi
      

  subnets:
  - us-west-2b
  cloudLabels:

  detailedInstanceMonitoring: true
---
apiVersion: kops/v1alpha2
kind: InstanceGroup
metadata:
  labels:
    kops.k8s.io/cluster: 1-16-dev.kops.cicdenv.com
  name: nodes-us-west-2c
spec:
  image: ami-0b685c2061ff41b7d
  machineType: r5d.xlarge
  maxSize: 1
  minSize: 1
  nodeLabels:
    kops.k8s.io/instancegroup: nodes-us-west-2c
  role: Node
  rootVolumeSize: 100
  iam:
    profile: arn:aws:iam::977594567050:instance-profile/kops-node
  additionalSecurityGroups: [sg-0f52c9ae7bc8bfb73]
  additionalUserData:
  - name: a-instance-stores
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      mount_dir=/mnt/ephemeral
      
      #
      # Configures NVMe instance stores.
      # This runs before docker/k8s are installed.
      #
      
      # Use script from our custom base AMI
      /usr/local/bin/mount-all-ephemeral-devices.sh "$mount_dir"
      
      #
      # Bind mounts for docker+kubernetes
      #
      for target_dir in        \
          /var/lib/containerd  \
          /var/lib/docker      \
          /var/lib/kubelet     \
          ; do
          real_dir="$mount_dir/$(basename $target_dir)"
      
          if [[ ! -d "$target_dir" ]]; then
              mkdir -p "$real_dir"
              mkdir -p "$target_dir"
      
              mount -o bind "$real_dir" "$target_dir"
          fi
      done
      
  - name: a-setup-dns
    type: text/x-shellscript
    content: |
      #!/bin/bash
      
      set -eu -o pipefail
      
      #
      # Fixed CoreDNS on nodes.
      #   Needed on ubuntu 18.04
      #
      
      # Stop systemd-resolved
      if systemctl is-active --quiet systemd-resolved; then
          systemctl disable systemd-resolved
          systemctl stop systemd-resolved
      fi
      
      # Link /etc/resolv.conf to /run/systemd/resolve/resolv.conf
      if [[ "$(readlink -- /etc/resolv.conf)" == "../run/systemd/resolve/stub-resolv.conf" ]]; then
          rm -f "/etc/resolv.conf"
          ln -s "/run/systemd/resolve/resolv.conf" "/etc/resolv.conf"
      fi
      

  subnets:
  - us-west-2c
  cloudLabels:

  detailedInstanceMonitoring: true
