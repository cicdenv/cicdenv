#!/bin/bash

set -eu -o pipefail

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
pushd "$DIR/.." >/dev/null

../../../bin/cicdctl creds aws-mfa main

AWS_PROFILE=admin-main
AWS_OPTS="--profile=${AWS_PROFILE} --region=us-west-2"

# Sorted list of regions
regions=$(aws ${AWS_OPTS} ec2 describe-regions | jq -r '.Regions[].RegionName' | sort)

# List variable
cat <<EOF | tee generated-variables.tf
variable "regions" {
  type = "list"
  default = [$(echo ${regions[@]} | sed 's/^/"/;s/$/"/;s/ /", "/g')]
  description = "Generated by ${BASH_SOURCE}"
}
EOF

# Providers and Modules
>generated-providers.tf
>generated-modules.tf
for region in $regions; do
    cat <<EOF | tee -a generated-providers.tf
provider "aws" {
  alias   = "${region}"
  region  = "${region}"
  profile = "admin-\${terraform.workspace}"
}

EOF

    cat <<EOF | tee -a generated-modules.tf
module "default_vpc-${region}" {
  source = "../modules/default-vpc"
  
  providers = {
    aws = "aws.${region}"
  }

  default_vpc_cidr         = "\${var.default_vpc_cidr["${region}"]}"
  default_vpc_subnet_cidrs = "\${var.default_vpc_subnet_cidrs["${region}"]}"
  default_vpc_subnet_azs   = "\${var.default_vpc_subnet_azs["${region}"]}"
}

EOF
done

# Remove unsightly extra blank lines
#   NOTE: using dd as workaround for Mac/linux sed incompatibilities
for generated_file in generated-modules.tf generated-providers.tf; do
    size=$(stat --format=%s "$generated_file")
    end=$(tail -n1 "$generated_file" | wc -c)
    pos=$(echo "$size - $end" | bc)

    dd if=/dev/null of="$generated_file" bs=1 "seek=${pos}" 2>/dev/null
done

popd >/dev/null
